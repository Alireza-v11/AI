import streamlit as st
import pandas as pd
from parsivar import Normalizer
from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression

st.title("ğŸ” ØªØ­Ù„ÛŒÙ„ Ø§Ø­Ø³Ø§Ø³Ø§Øª Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ")
st.markdown("Ø§Ø¨ØªØ¯Ø§ ÙØ§ÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†:")

uploaded_file = st.file_uploader("ğŸ“‚ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ CSV", type=["csv"])

if uploaded_file is not None:
    @st.cache_resource
    def load_model(data):
        df = pd.read_csv(data)[['Text', 'Suggestion']].dropna()
        df.columns = ['text', 'label']

        normalizer = Normalizer(statistical_space_correction=True)

        def clean_text(text):
            text = normalizer.normalize(str(text))
            return text.replace("ØŒ", "").replace(".", "").replace("ØŸ", "")

        df['clean_text'] = df['text'].apply(clean_text)

        X_train, _, y_train, _ = train_test_split(df['clean_text'], df['label'], test_size=0.2, random_state=42)

        vectorizer = TfidfVectorizer(max_features=3000)
        X_train_vec = vectorizer.fit_transform(X_train)

        model = LogisticRegression(max_iter=1000)
        model.fit(X_train_vec, y_train)

        return model, vectorizer, normalizer

    # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„
    model, vectorizer, normalizer = load_model(uploaded_file)

    st.markdown("Ù…ØªÙ† Ø®ÙˆØ¯Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† ØªØ§ Ø§Ø­Ø³Ø§Ø³Ø´ Ù…Ø´Ø®Øµ Ø¨Ø´Ù‡:")
    user_input = st.text_area("ğŸ“ Ø¬Ù…Ù„Ù‡:")

    if st.button("ØªØ­Ù„ÛŒÙ„ Ú©Ù†"):
        if user_input.strip() == "":
            st.warning("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ø¬Ù…Ù„Ù‡ ÙˆØ§Ø±Ø¯ Ú©Ù†.")
        else:
            def predict_sentiment(text):
                cleaned = normalizer.normalize(str(text)).replace("ØŒ", "").replace(".", "").replace("ØŸ", "")
                vec = vectorizer.transform([cleaned])
                pred = model.predict(vec)[0]
                return "Ù…Ø«Ø¨Øª ğŸ˜Š" if pred == 1 else "Ù…Ù†ÙÛŒ ğŸ˜ "

            result = predict_sentiment(user_input)
            st.success(f"Ù†ØªÛŒØ¬Ù‡ ØªØ­Ù„ÛŒÙ„: **{result}**")
else:
    st.info("Ù„Ø·ÙØ§Ù‹ ÛŒÚ© ÙØ§ÛŒÙ„ CSV Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†.")
